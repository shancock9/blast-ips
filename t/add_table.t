use strict;
use warnings;
use Test;
use Blast::IPS;

# In this test we test adding a new table and interpolating within it

BEGIN {

    plan tests => 2;

}
my $VERBOSE  = 0;

my $rtable_new;
my $symmetry       = 2;
my $gamma          = 1.4;
my $table_name_new = "S8000_G1X4";
my %options        = (
    symmetry   => $symmetry,
    rtable     => $rtable_new,
    gamma      => $gamma,
    table_name => $table_name_new,
);
my $blast_table_new = Blast::IPS->new( \%options );


# Get the built-in table for this case
my %args = ( 'symmetry' => $symmetry, 'gamma' => $gamma );
my $blast_table = Blast::IPS->new( \%args );
if ( !defined($blast_table) ) {
    die "missing table for sym=$symmetry, gamma=$gamma\n";
}
my $table_name = $blast_table->get_table_name();

# Get a copy of the builtin table
my $rtable = $blast_table->get_table();

# The difference in absolute error between the two tables should not exceed 5.e-7
# The maximum error for interpolating the builtin table to the new table points should
# also not exceed 5.e-7.  So
my $TOL  = 1.e-6;

# Case 1: Interpolate the builtin table to the new table points
my $err_max;
# Loop over all points in the new table
foreach my $item ( @{$rtable_new} ) {
    my ( $X_t,   $Y_t,   $dYdX_t )   = @{$item};

    # Interpolate the builtin table to the new table point
    my $ret = $blast_table->wavefront( 'X' => $X_t )->{'TableVars'};
    my ( $X, $Y, $dYdX, $Z, $dZdX ) = @{$ret};
    my $err = abs( $Y - $Y_t );
    if ( !defined($err_max) || $err > $err_max ) { $err_max = $err }

    if ($VERBOSE) {
        print "case 1: gamma=$gamma, sym=$symmetry, X=$X, Y=$Y, Yt=$Y_t, err=$err\n";
    }
}

if ( !ok( $err_max <= $TOL ) || $VERBOSE) {
    my $err_max_pr = sprintf "%0.3g", $err_max;
    print
"# Max error comparing '$table_name_new' with '$table_name' is $err_max_pr\n";
}

# Case 2: Interpolate the new table to the builtin table points.
# The difference in absolute error between the two tables should not exceed 5.e-7
# The maximum error for interpolating the new table to the builtin table points should
# not exceed 1.e-6. So
$TOL  = 1.5e-6;
$err_max=undef;

# Loop over all points in the builtin table
foreach my $item ( @{$rtable} ) {
    my ( $X_t,   $Y_t,   $dYdX_t )   = @{$item};

    # Interpolate the new table a builtin table point
    my $ret = $blast_table_new->wavefront( 'X'=>$X_t )->{'TableVars'};
    my ( $X, $Y, $dYdX, $Z, $dZdX ) = @{$ret};
    my $err = abs( $Y - $Y_t );
    if ( !defined($err_max) || $err > $err_max ) { $err_max = $err }

    if ($VERBOSE) {
        print "case 2: gamma=$gamma, sym=$symmetry, X=$X, Y=$Y, Yt=$Y_t, err=$err\n";
    }
}

if ( !ok( $err_max <= $TOL ) || $VERBOSE ) {
    my $err_max_pr = sprintf "%0.3g", $err_max;
    print
"# Case 2: Max error comparing '$table_name' with '$table_name_new' is $err_max_pr\n";
}

BEGIN {

	# This is the test table to add. This is from an 8000 point
	# calculation. The max interpolation error is 1.e-6, which 
	# is higher than the value 5.e-7 for the builtin table.

        # Overall Error Estimate:
        # Energy error to P=0.1 P0: 2.04e-07
        # Est Max FD Error (based on N/2 run) to R=20.01: 1.6e-7
        # Est Max MOC error for R>20.01: 2.87e-07 
        # Max interpolation error with cubic splines: 1.0055e-06
        # Est Max overall error after cubic interpolation: 1.4e-6

        # [ X, Y, dYdX, Z, dZdX]
        
        $rtable_new = [
        [-4.61798880, 12.00032860, -2.99997850, -4.61906014, 0.99839214],
        [-3.99663876, 10.13631445, -2.99987271, -3.99936179, 0.99591005],
        [-3.58468222, 8.90054843, -2.99956211, -3.58973934, 0.99239616],
        [-3.26779258, 7.95011114, -2.99886804, -3.27593888, 0.98773504],
        [-3.01304914, 7.18631353, -2.99757216, -3.02500685, 0.98196964],
        [-2.79749700, 6.54039198, -2.99537598, -2.81405134, 0.97499853],
        [-2.61094642, 5.98189417, -2.99193794, -2.63289302, 0.96680137],
        [-2.44578309, 5.48812279, -2.98684127, -2.47396394, 0.95730684],
        [-2.29698634, 5.04419070, -2.97960010, -2.33229790, 0.94643689],
        [-2.16071259, 4.63878487, -2.96963322, -2.20413672, 0.93407530],
        [-2.03362081, 4.26217268, -2.95619879, -2.08628816, 0.92002285],
        [-1.91347149, 3.90799763, -2.93843433, -1.97667798, 0.90407679],
        [-1.79746525, 3.56840774, -2.91510193, -1.87282876, 0.88583216],
        [-1.68280270, 3.23583193, -2.88445102, -1.77243822, 0.86468442],
        [-1.56475983, 2.89766894, -2.84327587, -1.67182677, 0.83934943],
        [-1.43162139, 2.52294997, -2.78318908, -1.56223135, 0.80616047],
        [-1.31250275, 2.19528733, -2.71614403, -1.46818134, 0.77229407],
        [-1.20274108, 1.90105882, -2.64339737, -1.38527774, 0.73782750],
        [-1.09927605, 1.63148582, -2.56624395, -1.31072783, 0.70288338],
        [-1.00084990, 1.38277298, -2.48670935, -1.24325402, 0.66794325],
        [-0.90442137, 1.14690646, -2.40485455, -1.18053955, 0.63268216],
        [-0.80857065, 0.92038256, -2.32158887, -1.12159496, 0.59722586],
        [-0.71271993, 0.70185490, -2.23830392, -1.06604435, 0.56196036],
        [-0.61588434, 0.48912064, -2.15581627, -1.01332343, 0.52708256],
        [-0.51723424, 0.28047176, -2.07488090, -0.96302913, 0.49281582],
        [-0.41587071, 0.07419068, -1.99604178, -0.91478851, 0.45933769],
        [-0.31098909, -0.13110982, -1.91980264, -0.86833654, 0.42684177],
        [-0.20186828, -0.33654999, -1.84662603, -0.82349131, 0.39552765],
        [-0.08754166, -0.54360791, -1.77673566, -0.78001513, 0.36550689],
        [0.03292069, -0.75356637, -1.71034727, -0.73773911, 0.33689399],
        [0.16046037, -0.96762519, -1.64763833, -0.69653383, 0.30978807],
        [0.29618075, -1.18715697, -1.58868580, -0.65625933, 0.28424225],
        [0.44118856, -1.41344000, -1.53355696, -0.61681707, 0.26030086],
        [0.59691753, -1.64816251, -1.48219715, -0.57806291, 0.23794986],
        [0.75865264, -1.88407299, -1.43619232, -0.54124032, 0.21788627],
        [0.92739917, -2.12285350, -1.39490058, -0.50603365, 0.19983489],
        [1.10443499, -2.36642549, -1.35772263, -0.47213480, 0.18353531],
        [1.29103812, -2.61656879, -1.32417134, -0.43929881, 0.16877379],
        [1.48841569, -2.87485976, -1.29385792, -0.40734253, 0.15537839],
        [1.69767432, -3.14266804, -1.26646776, -0.37613437, 0.14320933],
        [1.92041890, -3.42193060, -1.24167562, -0.34550223, 0.13212172],
        [2.15816006, -3.71438590, -1.21922718, -0.31532583, 0.12200216],
        [2.41187283, -4.02107492, -1.19894719, -0.28557374, 0.11277343],
        [2.68363649, -4.34434108, -1.18059607, -0.25610357, 0.10432952],
        [2.97511090, -4.68596732, -1.16400385, -0.22685085, 0.09659661],
        [3.28522453, -5.04456971, -1.14913890, -0.19801328, 0.08956756],
        [3.68784605, -5.50391394, -1.13318232, -0.16354629, 0.08188559],
        [4.12862956, -6.00017088, -1.11901932, -0.12903668, 0.07491552],
        [4.61158163, -6.53746468, -1.10646578, -0.09443243, 0.06858517],
        [5.14104788, -7.12025303, -1.09534894, -0.05969004, 0.06282937],
        [5.72409682, -7.75591246, -1.08547194, -0.02463826, 0.05757018],
        [6.36800767, -8.45192717, -1.07668018, 0.01083180, 0.05275027],
        [7.07989568, -9.21551547, -1.06885035, 0.04676115, 0.04832807],
        [7.86941934, -10.05653762, -1.06185640, 0.08326086, 0.04425864],
        [8.74627984, -10.98479576, -1.05560003, 0.12037483, 0.04051028],
        [9.72163805, -12.01155126, -1.04999325, 0.15814878, 0.03705456],
        [10.80840999, -13.14982035, -1.04495848, 0.19663149, 0.03386609],
        [12.01914422, -14.41215170, -1.04043641, 0.23579916, 0.03092764],
        [13.36780218, -15.81250678, -1.03637345, 0.27562787, 0.02822265],
        [14.87299221, -17.36959393, -1.03271494, 0.31617277, 0.02573065],
        [16.51777462, -19.06543376, -1.02948245, 0.35658587, 0.02348149],
        [18.32734551, -20.92565442, -1.02659740, 0.39716649, 0.02143408],
        [20.24527573, -22.89212464, -1.02410230, 0.43649423, 0.01963108],
        [22.46314552, -25.16074824, -1.02174710, 0.47805288, 0.01790002],
        [24.79341497, -27.53926107, -1.01972496, 0.51795194, 0.01638980],
        [27.48545611, -30.28174241, -1.01781391, 0.56006205, 0.01494100],
        [30.28095583, -33.12469425, -1.01618722, 0.60002924, 0.01369033],
        [33.50262344, -36.39594824, -1.01464737, 0.64214217, 0.01249078],
        [37.23985507, -40.18510750, -1.01319290, 0.68660779, 0.01134296],
        [41.08608460, -44.07965283, -1.01197058, 0.72830023, 0.01036660],
        [45.53081239, -48.57492804, -1.01081363, 0.77223321, 0.00943200],
        [50.01126122, -53.10161067, -1.00985419, 0.81268663, 0.00864881],
        [55.15652041, -58.29515325, -1.00894343, 0.85519633, 0.00789815],
        [61.10284752, -64.29200911, -1.00808074, 0.89995802, 0.00718028],
        [68.02307732, -71.26523853, -1.00726551, 0.94719711, 0.00649543],
        [74.89632940, -78.18608261, -1.00660404, 0.98985664, 0.00593488],
        [82.82467294, -86.16421507, -1.00597660, 1.03471778, 0.00539891],
        [92.03290078, -95.42464751, -1.00538282, 1.08199919, 0.00488765],
        [100.88931861, -104.32659604, -1.00491344, 1.12343069, 0.00448057],
        [111.04329492, -114.52812446, -1.00446695, 1.16688668, 0.00409080],
        [122.75853987, -126.29313585, -1.00404315, 1.21256004, 0.00371843],
        [136.36904580, -139.95584466, -1.00364181, 1.26067282, 0.00336351],
        [148.90568093, -152.53616799, -1.00333677, 1.30109104, 0.00309219],
        [163.20262019, -166.87867008, -1.00304587, 1.34338574, 0.00283211],
        [179.60268249, -183.32634215, -1.00276898, 1.38772918, 0.00258330],
        [198.53610751, -202.30962118, -1.00250601, 1.43431863, 0.00234580],
        [203.72621983, -207.51257358, -1.00244243, 1.44634284, 0.00228819],
        ];
}
