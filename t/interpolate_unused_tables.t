#!/usr/bin/perl 
use strict;
use warnings;
use Test;
use Blast::IPS;

# compare interpolation at gamma=1.65 with an actual table 

my $rtables;
my $rinfo;

BEGIN {

    $rinfo = {
        'S1.65' => [
            2,        1.65,     7.53e-07, 8000,   2.13e-07, 10,
            1.24e-07, 1.29e-07, 5e-07,    1749.1, -0.70001,
        ],
        'C1.65' => [
            1,       1.65,     6.93e-07, 8000,   2.2e-07, 50,
            1.3e-07, 6.31e-08, 5e-07,    87.836, -1.275,
        ],
        'P1.65' => [
            0, 1.65, 1.45e-06, 8000, 5.3e-07, 100, 3.74e-07, 5.8e-07, 5e-07,,,
        ],
    };

    my $num = scalar keys %{$rinfo};
    plan tests => $num;

}

my $tol = 2.5e-6;
foreach my $key ( keys %{$rinfo} ) {
    my $dY_max = 0;
    my $item   = $rinfo->{$key};
    my ( $symmetry, $gamma ) = @{$item};
    my $blast_table = Blast::IPS->new( symmetry => $symmetry, gamma => $gamma );
    my $rtab = $rtables->{$key};
    #print "sym=$symmetry, gam=$gamma, alpha_1=$alpha_1, alpha_2=$alpha_2, dalp=$dalpha\n";
    my $rbounds = $blast_table->get_table_bounds();
    my $Xmin= $rbounds->[0]->[0];
    my $Xmax= $rbounds->[1]->[0];
    foreach my $entry ( @{$rtab} ) {
        my ( $X, $Y, $dYdX, $Z, $dZdX ) = @{$entry};
        my ( $X_i, $Y_i, $dYdX_i, $Z_i, $dZdX_i ) =
          @{ $blast_table->lookup($X) };
	my $alpha_1 = $blast_table->get_alpha();
	my $alpha_2 = Blast::IPS::alpha_interpolate($symmetry, $gamma);
	my $dalpha=$alpha_2-$alpha_1;
        my $adY = abs( $Y - $Y_i );

	# Only compare table entries; do not look at extrapolations
	if ($X>=$Xmin && $X<=$Xmax) {
        if ( $adY > $dY_max ) { $dY_max = $adY }
	}
        #print STDERR "$X\t$Y\t$Y_i\t$adY\n";
    }
    ok( $dY_max < $tol ) || print STDERR "symmetry=$symmetry, gamma=$gamma, dY_max=$dY_max\n";
}

BEGIN {

    $rtables = {

        #    Overall Error Estimate:
        #    Energy error to P=0.1 P0: 2.21e-07
        #    Est Max FD Error (based on N/2 run) to R=50.01: 1.3e-7
        #    Est Max MOC error for R>50.01: -6.31e-08
        #    Max interpolation error with cubic splines: 5.0591e-07
        #    Est Max overall error after cubic interpolation: 6.9e-7

        # Run:C8000_G1x65
        'C1.65' => [
            [ -6.56207649, 12.00017704,  -1.99998470, -6.56346037, 0.99861517 ],
            [ -5.95326766, 10.78257642,  -1.99994830, -5.95581302, 0.99745146 ],
            [ -5.73346046, 10.34297534,  -1.99992433, -5.73663254, 0.99682301 ],
            [ -5.08758787, 9.05132963,   -1.99972593, -5.09364751, 0.99392282 ],
            [ -4.60732650, 8.09102804,   -1.99928414, -4.61713914, 0.99014270 ],
            [ -4.21955659, 7.31590761,   -1.99844683, -4.23404806, 0.98541473 ],
            [ -3.89550054, 6.66850308,   -1.99703624, -3.91558688, 0.97974164 ],
            [ -3.61332320, 6.10527019,   -1.99480663, -3.64003044, 0.97300562 ],
            [ -3.36395456, 5.60820775,   -1.99149203, -3.39832682, 0.96518428 ],
            [ -3.13966836, 5.16203462,   -1.98677299, -3.18281705, 0.95620955 ],
            [ -2.93452991, 4.75509532,   -1.98026503, -2.98767436, 0.94597859 ],
            [ -2.74406020, 4.37869961,   -1.97150958, -2.80856495, 0.93436094 ],
            [ -2.56422813, 4.02514480,   -1.95992262, -2.64168902, 0.92115442 ],
            [ -2.39133851, 3.68754227,   -1.94473765, -2.48369917, 0.90606491 ],
            [ -2.22151511, 3.35888908,   -1.92488145, -2.33126908, 0.88863995 ],
            [ -2.04862549, 3.02828111,   -1.89848101, -2.17937561, 0.86795962 ],
            [ -1.85860368, 2.67094081,   -1.86099067, -2.01689075, 0.84155604 ],
            [ -1.67888359, 2.34034444,   -1.81652994, -1.86816287, 0.81297049 ],
            [ -1.51414708, 2.04499337,   -1.76800368, -1.73660069, 0.78382835 ],
            [ -1.35964429, 1.77575397,   -1.71631505, -1.61775628, 0.75425566 ],
            [ -1.21284488, 1.52769086,   -1.66267136, -1.50919522, 0.72456495 ],
            [ -1.07061043, 1.29508310,   -1.60771601, -1.40824585, 0.69479009 ],
            [ -0.92884990, 1.07115613,   -1.55136172, -1.31188690, 0.66463380 ],
            [ -0.78740736, 0.85572694,   -1.49487040, -1.22000851, 0.63457398 ],
            [ -0.64477393, 0.64652262,   -1.43882697, -1.13163122, 0.60477136 ],
            [ -0.49962812, 0.44170886,   -1.38375157, -1.04599663, 0.57540168 ],
            [ -0.35074027, 0.23971951,   -1.33008535, -0.96248629, 0.54664315 ],
            [ -0.19682941, 0.03904944,   -1.27816160, -0.88052997, 0.51865374 ],
            [ -0.03659298, -0.16170190,  -1.22824357, -0.79962062, 0.49158282 ],
            [ 0.13112287,  -0.36363653,  -1.18059089, -0.71938710, 0.46559890 ],
            [ 0.30781964,  -0.56817150,  -1.13532877, -0.63934581, 0.44081049 ],
            [ 0.49493010,  -0.77652501,  -1.09259011, -0.55910484, 0.41733658 ],
            [ 0.69415494,  -0.99010983,  -1.05244136, -0.47820781, 0.39526089 ],
            [ 0.90735561,  -1.21039822,  -1.01492843, -0.39618702, 0.37465334 ],
            [ 1.13679580,  -1.43916131,  -0.98005042, -0.31247456, 0.35555347 ],
            [ 1.37468354,  -1.66851936,  -0.94904339, -0.22995578, 0.33866639 ],
            [ 1.62242702,  -1.90013250,  -0.92147484, -0.14795082, 0.32376905 ],
            [ 1.88178747,  -2.13585833,  -0.89694679, -0.06572924, 0.31065050 ],
            [ 2.15446487,  -2.37737806,  -0.87514093, 0.01736029,  0.29913878 ],
            [ 2.44210610,  -2.62624112,  -0.85579856, 0.10191311,  0.28909112 ],
            [ 2.74645766,  -2.88402297,  -0.83869720, 0.18852788,  0.28038205 ],
            [ 3.06907598,  -3.15209888,  -0.82365697, 0.27773472,  0.27290665 ],
            [ 3.41172303,  -3.43199538,  -0.81051001, 0.37011679,  0.26656472 ],
            [ 3.77620211,  -3.72525867,  -0.79910599, 0.46626767,  0.26126348 ],
            [ 4.16459306,  -4.03365018,  -0.78930112, 0.56685666,  0.25691220 ],
            [ 4.57869379,  -4.35870809,  -0.78096924, 0.67248638,  0.25342670 ],
            [ 5.02101585,  -4.70253717,  -0.77397574, 0.78394984,  0.25071788 ],
            [ 5.49406617,  -5.06723846,  -0.76819434, 0.90204365,  0.24869914 ],
            [ 6.00154052,  -5.45582702,  -0.76349190, 1.02786443,  0.24728113 ],
            [ 6.54691926,  -5.87114469,  -0.75974590, 1.16245564,  0.24637820 ],
            [ 7.13667280,  -6.31829660,  -0.75682305, 1.30759717,  0.24590348 ],
            [ 7.77645669,  -6.80174665,  -0.75460756, 1.46486459,  0.24577620 ],
            [ 8.47671767,  -7.32955828,  -0.75297747, 1.63700913,  0.24591861 ],
            [ 9.25169215,  -7.91261348,  -0.75182170, 1.82771386,  0.24626043 ],
            [ 10.12160809, -8.56626430,  -0.75103959, 2.04214430,  0.24673875 ],
            [ 11.11708679, -9.31363400,  -0.75054111, 2.28804816,  0.24729837 ],
            [ 12.28754439, -10.19191727, -0.75024783, 2.57785690,  0.24789194 ],
            [ 13.71879343, -11.26558131, -0.75009385, 2.93309093,  0.24847910 ],
            [ 15.57964514, -12.66131862, -0.75002600, 3.39601619,  0.24902510 ],
            [ 18.28151417, -14.68775195, -0.75000390, 4.06955632,  0.24949800 ],
            [ 23.36744153, -18.50220279, -0.75000010, 5.33958933,  0.24985848 ],
        ],

        #    Overall Error Estimate:
        #    Energy error to P=0.1 P0: 5.29e-07
        #    Est Max FD Error (based on N/2 run) to R=100.04: 3.7e-7
        #    Est Max MOC error for R>100.04: 5.8e-07
        #    Max interpolation error with cubic splines: 5.0496e-07
        #    Est Max overall error after cubic interpolation: 1.45e-6

        # Run:P8000_G1x65
        'P1.65' => [
            [
                -11.92332761, 12.00017791, -0.99999235, -11.92517321,
                0.99907636
            ],
            [
                -11.01565693, 11.09251903, -0.99998104, -11.01856405,
                0.99854436
            ],
            [ -9.72867051, 9.80558584,   -0.99992645, -9.73421021, 0.99722270 ],
            [ -8.62915480, 8.70621753,   -0.99977907, -8.63877293, 0.99516897 ],
            [ -7.76397748, 7.84134393,   -0.99947573, -7.77883756, 0.99251903 ],
            [ -7.05096388, 7.12887519,   -0.99893220, -7.07225037, 0.98925600 ],
            [ -6.44418369, 6.52298490,   -0.99804633, -6.47310995, 0.98535895 ],
            [ -5.91364158, 5.99380728,   -0.99669259, -5.95149290, 0.98078577 ],
            [ -5.44059049, 5.52275084,   -0.99472352, -5.48873173, 0.97549209 ],
            [ -5.01190747, 5.09688014,   -0.99196700, -5.07180694, 0.96942442 ],
            [ -4.61696918, 4.70580983,   -0.98821302, -4.69026477, 0.96250024 ],
            [ -4.24765188, 4.34171763,   -0.98320925, -4.33620676, 0.95461617 ],
            [ -3.89645675, 3.99751477,   -0.97663144, -4.00248406, 0.94561716 ],
            [ -3.55557251, 3.66599271,   -0.96802969, -3.68185535, 0.93525641 ],
            [ -3.21593808, 3.33905035,   -0.95672907, -3.36621568, 0.92312958 ],
            [ -2.86068108, 3.00177524,   -0.94139065, -3.04083064, 0.90832497 ],
            [ -2.48011554, 2.64735332,   -0.92039218, -2.69857067, 0.88992324 ],
            [ -2.13667355, 2.33512679,   -0.89715107, -2.39611213, 0.87106750 ],
            [ -1.81797334, 2.05311255,   -0.87210033, -2.12152950, 0.85181002 ],
            [ -1.52257652, 1.79925035,   -0.84632703, -1.87270572, 0.83268391 ],
            [ -1.24256685, 1.56589561,   -0.82021827, -1.64218822, 0.81369963 ],
            [ -0.96713484, 1.34363258,   -0.79360926, -1.42070292, 0.79451843 ],
            [ -0.68783554, 1.12578121,   -0.76639526, -1.20153654, 0.77487856 ],
            [ -0.39896813, 0.90841124,   -0.73872200, -0.98062041, 0.75470577 ],
            [ -0.10409969, 0.69461625,   -0.71162300, -0.76106283, 0.73458946 ],
            [ 0.20028117,  0.48205299,   -0.68540132, -0.54053031, 0.71462352 ],
            [ 0.51826175,  0.26816644,   -0.66028932, -0.31646594, 0.69487838 ],
            [ 0.85405951,  0.05051531,   -0.63650943, -0.08643281, 0.67544442 ],
            [ 1.21302218,  -0.17387240,  -0.61422324, 0.15255240,  0.65638791 ],
            [ 1.60094829,  -0.40803462,  -0.59360518, 0.40351172,  0.63780851 ],
            [ 2.01089996,  -0.64752921,  -0.57537164, 0.66133289,  0.62036867 ],
            [ 2.42006670,  -0.87978122,  -0.56036420, 0.91196623,  0.60505598 ],
            [ 2.83678005,  -1.11060056,  -0.54787558, 1.16119349,  0.59141119 ],
            [ 3.26662741,  -1.34378470,  -0.53746747, 1.41271700,  0.57917278 ],
            [ 3.71396098,  -1.58220493,  -0.52883034, 1.66927870,  0.56817364 ],
            [ 4.18291815,  -1.82846676,  -0.52171866, 1.93334922,  0.55828994 ],
            [ 4.67709169,  -2.08479317,  -0.51593434, 2.20699286,  0.54943602 ],
            [ 5.20303946,  -2.35486441,  -0.51128055, 2.49381934,  0.54150176 ],
            [ 5.76383335,  -2.64050686,  -0.50762080, 2.79545258,  0.53445644 ],
            [ 6.36713197,  -2.94585368,  -0.50480179, 3.11594586,  0.52822393 ],
            [ 7.02014626,  -3.27476414,  -0.50269674, 3.45903448,  0.52276008 ],
            [ 7.73005090,  -3.63105655,  -0.50119059, 3.82840000,  0.51803353 ],
            [ 8.52233901,  -4.02769828,  -0.50015720, 4.23713505,  0.51393202 ],
            [ 9.39820418,  -4.46546037,  -0.49952265, 4.68569518,  0.51050338 ],
            [ 10.41009828, -4.97072744,  -0.49918608, 5.20072631,  0.50761425 ],
            [ 11.56398974, -5.54665527,  -0.49908441, 5.78504800,  0.50531700 ],
            [ 12.96223264, -6.24452804,  -0.49915091, 6.49022635,  0.50348570 ],
            [ 14.71582972, -7.11999139,  -0.49933342, 7.37180660,  0.50209535 ],
            [ 17.23782092, -8.37964441,  -0.49959146, 8.63659427,  0.50104169 ],
            [ 20.77255022, -10.14601678, -0.49982129, 10.40633706, 0.50040512 ],
        ],

        #    Overall Error Estimate:
        #    Energy error to P=0.1 P0: 2.13e-07
        #    Est Max FD Error (based on N/2 run) to R=10.00: 1.2e-7
        #    Est Max MOC error for R>10.00: 1.29e-07
        #    Max interpolation error with cubic splines: 5.0865e-07
        #    Est Max overall error after cubic interpolation: 7.5e-7
        #

        # Run:S8000_G1x65
        'S1.65' => [
            [ -4.47863114, 12.00017656,  -2.99997705, -4.47973810, 0.99833866 ],
            [ -4.11224849, 10.90104219,  -2.99993112, -4.11416707, 0.99711943 ],
            [ -3.54509442, 9.19967033,   -2.99966765, -3.54959209, 0.99323902 ],
            [ -3.20592172, 8.18234789,   -2.99908184, -3.21341285, 0.98872447 ],
            [ -2.94087657, 7.38758428,   -2.99796736, -2.95204333, 0.98316707 ],
            [ -2.71782209, 6.71906566,   -2.99603857, -2.73345595, 0.97639528 ],
            [ -2.52432906, 6.13962384,   -2.99294502, -2.54527239, 0.96832635 ],
            [ -2.35446277, 5.63158414,   -2.98831332, -2.38154611, 0.95897614 ],
            [ -2.20203143, 5.17654080,   -2.98166695, -2.23615438, 0.94824289 ],
            [ -2.06295831, 4.76246981,   -2.97244722, -2.10509946, 0.93601793 ],
            [ -1.93407493, 4.38012603,   -2.95998045, -1.98532710, 0.92215157 ],
            [ -1.81280585, 4.02211988,   -2.94344407, -1.87442286, 0.90644248 ],
            [ -1.69646368, 3.68087370,   -2.92171634, -1.76997785, 0.88854266 ],
            [ -1.58256389, 3.34963476,   -2.89328651, -1.66991461, 0.86796483 ],
            [ -1.46711752, 3.01769984,   -2.85553320, -1.57107783, 0.84369292 ],
            [ -1.34184024, 2.66314769,   -2.80251371, -1.46724685, 0.81318817 ],
            [ -1.21945142, 2.32400553,   -2.73724839, -1.36976400, 0.77911914 ],
            [ -1.10767420, 2.02193533,   -2.66576409, -1.28458154, 0.74449943 ],
            [ -1.00308942, 1.74705661,   -2.58939218, -1.20853031, 0.70946257 ],
            [ -0.90408545, 1.49457294,   -2.51010020, -1.14001168, 0.67444484 ],
            [ -0.80845869, 1.25839578,   -2.42886416, -1.07718196, 0.63947933 ],
            [ -0.71294389, 1.03038871,   -2.34515372, -1.01779311, 0.60403868 ],
            [ -0.61778793, 0.81123178,   -2.26117291, -0.96199387, 0.56882001 ],
            [ -0.52193721, 0.59850915,   -2.17778721, -0.90914819, 0.53399921 ],
            [ -0.42449281, 0.39031933,   -2.09578241, -0.85879190, 0.49977357 ],
            [ -0.32465007, 0.18509950,   -2.01584646, -0.81057707, 0.46634712 ],
            [ -0.22146394, -0.01886534,  -1.93841899, -0.76415166, 0.43385871 ],
            [ -0.11419175, -0.22275547,  -1.86399257, -0.71931526, 0.40249836 ],
            [ -0.00188069, -0.42804193,  -1.79283017, -0.67582756, 0.37237945 ],
            [ 0.11634216,  -0.63592597,  -1.72520008, -0.63353254, 0.34362929 ],
            [ 0.24141839,  -0.84763185,  -1.66128607, -0.59229139, 0.31634490 ],
            [ 0.37444485,  -1.06454323,  -1.60116987, -0.55195821, 0.29058051 ],
            [ 0.51654130,  -1.28797585,  -1.54491615, -0.51242527, 0.26638074 ],
            [ 0.66902951,  -1.51946445,  -1.49250790, -0.47357155, 0.24375132 ],
            [ 0.82807721,  -1.75300073,  -1.44534815, -0.43646840, 0.22331045 ],
            [ 0.99381164,  -1.98895319,  -1.40307682, -0.40102009, 0.20491423 ],
            [ 1.16747699,  -2.22923359,  -1.36506481, -0.36691236, 0.18829767 ],
            [ 1.35049691,  -2.47584736,  -1.33076890, -0.33386376, 0.17322923 ],
            [ 1.54395534,  -2.73022161,  -1.29980668, -0.30170838, 0.15954540 ],
            [ 1.74918287,  -2.99402861,  -1.27181854, -0.27027600, 0.14709120 ],
            [ 1.96740936,  -3.26873717,  -1.24651668, -0.23944704, 0.13574257 ],
            [ 2.20003875,  -3.55597885,  -1.22363656, -0.20910529, 0.12538533 ],
            [ 2.44872730,  -3.85763692,  -1.20293331, -0.17913184, 0.11591377 ],
            [ 2.71485020,  -4.17520466,  -1.18422095, -0.14946765, 0.10724890 ],
            [ 3.00014646,  -4.51057720,  -1.16731059, -0.12003199, 0.09931066 ],
            [ 3.30669152,  -4.86599958,  -1.15202341, -0.09073502, 0.09202363 ],
            [ 3.63655123,  -5.24366062,  -1.13820868, -0.06151384, 0.08532567 ],
            [ 3.99198343,  -5.64593323,  -1.12572812, -0.03231070, 0.07916084 ],
            [ 4.37563829,  -6.07559651,  -1.11444980, -0.00305931, 0.07347633 ],
            [ 4.79055817,  -6.53582484,  -1.10425153, 0.02630926,  0.06822399 ],
            [ 5.23997784,  -7.02996175,  -1.09502600, 0.05584952,  0.06336293 ],
            [ 5.72732527,  -7.56152416,  -1.08667763, 0.08560286,  0.05885815 ],
            [ 6.25702253,  -8.13506937,  -1.07911008, 0.11564257,  0.05467351 ],
            [ 6.83348611,  -8.75509805,  -1.07224423, 0.14600865,  0.05078138 ],
            [ 7.46172806,  -9.42670823,  -1.06600715, 0.17674318,  0.04715657 ],
            [ 8.14755677,  -10.15580131, -1.06033163, 0.20789478,  0.04377586 ],
            [ 8.89717780,  -10.94865114, -1.05516012, 0.23949615,  0.04062019 ],
            [ 9.71719464,  -11.81190765, -1.05044303, 0.27156538,  0.03767371 ],
            [ 10.61520936, -12.75322798, -1.04613462, 0.30412825,  0.03492129 ],
            [ 11.59902309, -13.78043420, -1.04219706, 0.33718625,  0.03235108 ],
            [ 12.67683639, -14.90172977, -1.03859750, 0.37072760,  0.02995284 ],
            [ 13.85824956, -16.12673875, -1.03530447, 0.40475716,  0.02771569 ],
            [ 15.15246268, -17.46463606, -1.03229302, 0.43924210,  0.02563170 ],
            [ 16.57087582, -18.92684098, -1.02953735, 0.47418468,  0.02369100 ],
            [ 18.12468897, -20.52453241, -1.02701652, 0.50955534,  0.02188599 ],
            [ 19.71307656, -22.15406531, -1.02485191, 0.54303676,  0.02031216 ],
            [ 21.45084667, -23.93323531, -1.02285163, 0.57701990,  0.01883726 ],
            [ 23.41748347, -25.94288456, -1.02094620, 0.61262767,  0.01741299 ],
            [ 25.49553859, -28.06265692, -1.01925202, 0.64744483,  0.01613002 ],
            [ 27.84934812, -30.45982653, -1.01763786, 0.68391550,  0.01489241 ],
            [ 30.32539980, -32.97773220, -1.01620960, 0.71938179,  0.01378431 ],
            [ 33.13108085, -35.82692656, -1.01484838, 0.75651667,  0.01271628 ],
            [ 36.06517862, -38.80278417, -1.01365054, 0.79239700,  0.01176634 ],
            [ 39.38893733, -42.16996026, -1.01250832, 0.82994278,  0.01085124 ],
            [ 42.83828399, -45.66068182, -1.01150949, 0.86594238,  0.01004329 ],
            [ 46.74127216, -49.60667734, -1.01055624, 0.90358107,  0.00926514 ],
            [ 50.75161125, -53.65764598, -1.00972874, 0.93933578,  0.00858378 ],
            [ 55.27934084, -58.22758398, -1.00893806, 0.97667483,  0.00792742 ],
            [ 60.41607776, -63.40823912, -1.00818381, 1.01572914,  0.00729621 ],
            [ 65.65247124, -68.68574290, -1.00753580, 1.05246654,  0.00674976 ],
            [ 71.57384351, -74.64985202, -1.00691670, 1.09083487,  0.00622393 ],
            [ 78.30349331, -81.42400270, -1.00632621, 1.13097155,  0.00571883 ],
            [ 85.08621066, -88.24788278, -1.00582513, 1.16825863,  0.00528734 ],
            [ 92.75862445, -95.96309968, -1.00534624, 1.20718944,  0.00487237 ],
            [
                101.48161569, -104.73067403, -1.00488935, 1.24790361,
                0.00447400
            ],
            [
                110.13118226, -113.42083499, -1.00450746, 1.28511538,
                0.00413909
            ],
            [
                119.90005402, -123.23190485, -1.00414213, 1.32393339,
                0.00381699
            ],
            [
                130.98807741, -134.36386526, -1.00379324, 1.36449282,
                0.00350771
            ],
            [
                141.72724402, -145.14219177, -1.00350716, 1.40075959,
                0.00325287
            ],
            [
                153.80516075, -157.26076690, -1.00323297, 1.43852666,
                0.00300751
            ],
            [
                167.45200094, -170.94988610, -1.00297059, 1.47791611,
                0.00277165
            ],
            [
                182.94944632, -186.49136880, -1.00271995, 1.51906564,
                0.00254532
            ],
            [
                197.52604567, -201.10612113, -1.00251997, 1.55481344,
                0.00236400
            ],
            [
                213.87310019, -217.49275953, -1.00232804, 1.59199335,
                0.00218932
            ],
        ],

    };
}
